/**
 * iqo 0.1.15
 * lihz <854323752@qq.com>
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).IQO=t()}(this,function(){"use strict";var e,d=(function(e){var t,o,l,d,f,w,i;t=window,o=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,l=t.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),d=l&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),f=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,w=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,i=(l||f)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(e){var t,n,r,o,i,a,s,u,c;if(!(t=e.match(w)))throw new Error("invalid data URI");for(n=t[2]?t[1]:"text/plain"+(t[3]||";charset=US-ASCII"),r=!!t[4],o=e.slice(t[0].length),i=r?atob(o):decodeURIComponent(o),a=new ArrayBuffer(i.length),s=new Uint8Array(a),u=0;u<i.length;u+=1)s[u]=i.charCodeAt(u);return l?new Blob([d?s:a],{type:n}):((c=new f).append(a),c.getBlob(n))},t.HTMLCanvasElement&&!o.toBlob&&(o.mozGetAsFile?o.toBlob=function(e,t,n){var r=this;setTimeout(function(){n&&o.toDataURL&&i?e(i(r.toDataURL(t,n))):e(r.mozGetAsFile("blob",t))})}:o.toDataURL&&i&&(o.toBlob=function(e,t,n){var r=this;setTimeout(function(){e(i(r.toDataURL(t,n)))})})),e.exports?e.exports=i:t.dataURLtoBlob=i}(e={exports:{}},e.exports),e.exports);function t(e){this.prefix="[IQO]",this.standard=!isNaN(e)&&0<e?e:600,this.URL=this._URLCompat()}var n=t.prototype={constructor:t};return n._URLCompat=function(){return"URL"in window&&"function"==typeof window.URL.createObjectURL?window.URL:"webkitURL"in window?window.webkitURL:"mozURL"in window?window.mozURL:"msURL"in window?window.msURL:null},n._generateFileURLByURL=function(e){return this.URL.createObjectURL(e)},n._generateFileURLByFileReader=function(e,t,n){var r=new FileReader;r.onload=function(){t(r.result)},r.onerror=n,r.readAsDataURL(e)},n._generateFileURL=function(n){var r=this;return new Promise(function(e,t){r.URL?e(r._generateFileURLByURL(n)):"FileReader"in window?r._generateFileURLByFileReader(n,e,t):t(new Error("您的浏览器不支持window.URL和FileReader！"))})},n._revokeFileURL=function(e){this.URL&&this.URL.revokeObjectURL(e)},n._file2Image=function(r){var o=this;return new Promise(function(e,t){var n=new Image;n.onload=function(){return e(n)},n.onerror=function(e){console.error(o.prefix+"图片加载失败！",e),t(e)},n.src=r})},n._drawImage=function(a,s,u,c){var l=this;return new Promise(function(e,t){c=a.width<l.standard&&a.height<l.standard?1:c/100,u/=100,l.canvas||(l.canvas=document.createElement("canvas"),l.ctx=l.canvas.getContext("2d"));var n=l.canvas,r=l.ctx,o=a.width*c,i=a.height*c;n.setAttribute("width",o),n.setAttribute("height",i),n.width=o,n.height=i;try{r.clearRect(0,0,o,i),r.save(),r.drawImage(a,0,0,a.width,a.height,0,0,o,i),r.restore(),n.toBlob?n.toBlob(e,s,u):e(d(n.toDataURL(s,u))),r.clearRect(0,0,o,i)}catch(e){t(e)}})},t.prototype.compress=function(n,t,r){var o=this,i=n.type||"image/"+n.substr(n.lastIndexOf(".")+1),a=null;return t=Number(t),(isNaN(t)||t<=0||100<t)&&(t=70),r=Number(r),(isNaN(r)||r<=0||100<r)&&(r=70),this._generateFileURL(n).then(function(e){return o._file2Image(a=e)}).then(function(e){return o._drawImage(e,i,t,r)}).then(function(e){if(e&&0<e.size&&e.size<n.size){var t=new Date;return e.lastModified=t.getTime(),e.lastModifiedDate=t,e.name=n.name,e}return n}).catch(function(e){return console.error(e),n}).then(function(e){return o._revokeFileURL(a),e})},t});
